<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="transport-datalist">
	<template>
		<style>
			paper-input {
				--primary-text-color: var(--primary-input-color);
				--primary-color: var(--primary-input-color);
				--secondary-text-color: var(--secondary-input-color);
				--disabled-text-color: var(--secondary-input-color);
				max-width: 300px;
				min-width: 250px;
			}
		</style>

		<iron-ajax
			id="bartStations"
			url="http://api.bart.gov/api/stn.aspx?cmd=stns&key=MW9S-E7SL-26DU-VV8V"
			handle-as="xml"
			last-response="{{bartStationsResponse}}"></iron-ajax>
		
		<paper-input
			autofocus="[[autofocus]]"
			list="stations"
			label="[[label]]"
			value="{{stationName}}">
		</paper-input>
		<datalist id="stations">
			<template is="dom-repeat" items="[[stations]]">
				<option value="[[item.name]]"></option>
			</template>
		</datalist>

	</template>
	<script>
		
	Polymer({

		is: 'transport-datalist',

		properties: {
			stations: {
				type: Array,
				notify: true
			},
			stationName: {
				type: String,
				notify: true
			},
			stationAbbr: {
				type: String,
				notify: true
			},
			address: {
				type: String,
				notify: true
			}
		},

		ready: function() {
			var self = this;
			return keyValStore.get('stations').then(function(data) {
				if (data) {
					self.stations = data;
					self.bool = true;
					return data;
				}
				else {
					return self.$.bartStations.generateRequest();
				}
			});
		},

		observers: [
			'_setAbbrAddress(stationName)',
			'_handleBartStations(bartStationsResponse)'
		],

		_handleBartStations: function(response) {
			var self = this;
			var list = [];
			var stations = response.firstChild.childNodes[1].childNodes;

			stations.forEach(function(station) {
				list.push({
					name: station.childNodes[0].textContent,
					abbr: station.childNodes[1].textContent,
					address: station.childNodes[4].textContent + ' ' + station.childNodes[5].textContent + ', CA'
				});
			});

			self.stations = list;

			return keyValStore.set('stations', list);
		},

		_setAbbrAddress: function(stationName) {
			if (this.stations) {
				var len = this.stations.length;
				for (var i = 0; i < len; i++) {
					if (this.stations[i].name === this.stationName) {
						this.stationAbbr = this.stations[i].abbr;
						this.address = this.stations[i].address;
					}
				}
			}
		}

	});

	</script>
</dom-module>