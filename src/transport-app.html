<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-storage/app-network-status-behavior.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="transport-control-panel.html">
<link rel="import" href="transport-map.html">

<dom-module id="transport-app">
	<template>
		<style>
			:host {
				display: flex;
				--primary-bg-color: #4285f4;
				--secondary-bg-color: #fff;
				--primary-input-color: #fff;
				--secondary-input-color: #b3cefb;
				--panel-width: 425px;
				--panel-inputs-height: 160px;
				--panel-results-height: calc(100vh - var(--panel-inputs-height));
				--map-width: calc(100% - var(--panel-width));
			}

			.alternate {
				width: var(--map-width);
			}
		</style>

		<iron-ajax
			id="bartRouteAjax"
			url="[[url]]"
			handle-as="xml"
			last-response="{{bartRouteResponse}}"
			></iron-ajax>
		
		<transport-control-panel></transport-control-panel>
		
		<transport-map
			hidden$="[[!online]]"
			start-address="{{start}}"
			end-address="{{end}}"
			latitude="37.779"
			longitude="-122.3892"></transport-map>
		<div class="alternate" hidden$="[[online]]">
			<p>Some awesome stuff</p>
		</div>
	</template>
	<script>
		
	Polymer({

		is: 'transport-app',

		behaviors: [Polymer.AppNetworkStatusBehavior],

		properties: {
			cmd: {
				type: String,
				value: 'depart',
				notify: true
			},
			orig: {
				type: String,
				notify: true
			},
			dest: {
				type: String,
				notify: true
			},
			time: {
				type: String,
				value: '7:00 pm',
				notify: true
			},
			start: {
				type: String,
				notify: true
			},
			end: {
				type: String,
				notify: true
			},
			url: {
				type: String,
				notify: true,
				computed: '_computeUrl(cmd, orig, dest, time)'
			}
		},

		observers: [
			'_handleRouteResponse(bartRouteResponse)'
		],

		listeners: {
			'search': 'fetchTrip',
			'stations': 'updateRoute'
		},

		fetchTrip: function(e) {
			this.$.bartRouteAjax.generateRequest();
		},

		updateRoute: function(e) {
			this.orig = e.detail.startVal;
			this.dest = e.detail.endVal;
			this.start = e.detail.startAddress;
			this.end = e.detail.endAddress;
		},

		_computeUrl: function(cmd, orig, dest, time) {
			return 'http://api.bart.gov/api/sched.aspx?cmd=' + cmd + '&orig=' + orig + '&dest=' + dest + '&time=' + time + '&b=0&a=4&key=MW9S-E7SL-26DU-VV8V';
		},

		_handleRouteResponse: function(route) {
			console.log(route);
		}

	});

	</script>
</dom-module>