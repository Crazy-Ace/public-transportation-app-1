<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-storage/app-network-status-behavior.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/font-roboto/roboto.html">
<link rel="import" href="transport-control-panel.html">
<link rel="import" href="transport-map.html">
<link rel="import" href="transport-offline-view.html">

<dom-module id="transport-app">
	<template>
		<style>
			:host {
				display: flex;
				--primary-txt-color: #000;
				--secondary-txt-color: #888;
				--primary-bg-color: #4285f4;
				--secondary-bg-color: #fff;
				--tertiary-bg-color: #e6e6e6;
				--primary-input-color: #fff;
				--secondary-input-color: #b3cefb;
				--paper-input-container-invalid-color: #fff;
				--panel-width: 425px;
				--panel-inputs-height: 202px;
				--panel-results-height: calc(100vh - var(--panel-inputs-height));
				--progress-color: #3367d6;
				--map-width: calc(100% - var(--panel-width));
				font-family: 'Roboto', Helvetica, sans-serif;
			}


			@media (max-width: 770px) {
				:host {
					--panel-width: 100%;
				}

				transport-map {
					display: none;
				}
			}

			@media (max-width: 410px) {
				:host {
					--panel-inputs-height: 232px;
				}
			}
		</style>

		<iron-ajax
			id="bartRouteAjax"
			url="[[url]]"
			handle-as="xml"
			last-response="{{bartRouteResponse}}">
		</iron-ajax>
		
		<transport-control-panel
			trip-data="{{tripData}}">
		</transport-control-panel>
		
		<transport-map
			id="tripMap"
			hidden$="[[!online]]"
			latitude="37.779"
			longitude="-122.3892">
		</transport-map>
		
		<transport-offline-view
			hidden$="[[online]]"></transport-offline-view>
	</template>
	<script>
		
	Polymer({

		is: 'transport-app',

		behaviors: [Polymer.AppNetworkStatusBehavior],

		properties: {
			cmd: {
				type: String,
				value: 'depart',
				notify: true
			},
			orig: {
				type: String,
				notify: true
			},
			dest: {
				type: String,
				notify: true
			},
			time: {
				type: String,
				notify: true
			},
			start: {
				type: String,
				notify: true
			},
			end: {
				type: String,
				notify: true
			},
			url: {
				type: String,
				notify: true,
				computed: '_computeUrl(cmd, orig, dest, time)'
			},
			key: {
				type: String,
				notify: true
			},
			tripData: {
				type: Array,
				notify: true
			},
			wentOffline: {
				type: Boolean,
				value: false,
				notify: true
			}
		},

		observers: [
			'_handleRouteResponse(bartRouteResponse)',
			'_reloadMap(online)'
		],

		listeners: {
			'search': 'fetchTrip',
			'stations': 'updateRoute'
		},

		fetchTrip: function(e) {
			var self = this;
			this.key = [this.cmd, this.orig, this.dest, this.time].join('-');

			if (this.online) {
				this.$.tripMap.startAddress = this.start;
				this.$.tripMap.endAddress = this.end;
				return this.$.bartRouteAjax.generateRequest();
			}
			else {
				keyValStore.get(this.key).then(function(val) {
					self.tripData = val;
				});
			}
		},

		updateRoute: function(e) {
			this.orig = e.detail.startAbbr;
			this.dest = e.detail.endAbbr;
			this.start = e.detail.startAddress;
			this.end = e.detail.endAddress;
			this.time = this.formatTime(e.detail.time);
		},

		_computeUrl: function(cmd, orig, dest, time) {
			return 'http://api.bart.gov/api/sched.aspx?cmd=' + cmd + '&orig=' + orig + '&dest=' + dest + '&time=' + time + '&b=0&a=4&key=MW9S-E7SL-26DU-VV8V';
		},

		_handleRouteResponse: function(route) {
			console.log(route);
			var trips = route.firstChild.childNodes[4].childNodes[4].childNodes;
			var length = trips.length;
			var result = [];

			for (var i = 0; i < length; i++) {
				result.push({
					start: trips[i].getAttribute('origin'),
					end: trips[i].getAttribute('destination'),
					depart: trips[i].getAttribute('origTimeMin'),
					arrive: trips[i].getAttribute('destTimeMin'),
					fare: trips[i].getAttribute('fare')
				});
			}

			this.tripData = result;
			return keyValStore.set(this.key, result);
		},

		_reloadMap: function(online) {
			if (online && this.wentOffline) {
				this.$.tripMap.resize();
			}
			else if (!online) {
				this.wentOffline = true;
			}
		},

		formatTime: function(time) {
			if (!time) {
				return 'now';
			}

			var split = time.split(':');
			var hour = parseInt(split[0], 10);
			var formattedHour;
			var formattedTime = '';

			if (hour > 12) {
				formattedHour = hour - 12;
				formattedTime += formattedHour + ':' + split[1] + 'pm';
				return formattedTime;
			}
			else {
				formattedTime += split[0] + ':' + split[1] + 'am';
				return formattedTime;
			}
		}

	});

	</script>
</dom-module>